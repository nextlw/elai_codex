flowchart TD
    subgraph Entrada["üéØ ENTRADA DO USU√ÅRIO"]
        A1["Usu√°rio envia prompt<br/>codex-cli/bin/codex.js<br/>codex-rs/tui/src/main.rs"]
    end

    subgraph Core["üîß N√öCLEO CODEX"]
        B1["Recebe prompt<br/>codex-rs/core/src/codex.rs<br/><code>Session::handle_message()</code>"]
        B2["Processa e armazena<br/>codex_conversation.rs<br/><code>ConversationManager</code>"]
        B3["Envia ao LLM<br/>chat_completions.rs<br/><code>make_chat_completion()</code>"]
    end

    subgraph LLM["ü§ñ LLM E TOOL CALL"]
        C1["LLM retorna FunctionCall<br/><code>ResponseInputItem::FunctionCall {<br/>  call_id: String,<br/>  name: 'exec_command',<br/>  arguments: '{...}'<br/>}</code>"]
    end

    subgraph Resolution["üîç RESOLU√á√ÉO DE FERRAMENTA"]
        D1["Identifica ferramenta<br/>mcp_connection_manager.rs<br/><code>McpConnectionManager::parse_tool_name()</code>"]
        D2["Tipos definidos em:<br/>protocol/models.rs<br/><code>pub struct Tool {<br/>  pub name: String,<br/>  pub description: Option&lt;String&gt;<br/>}</code>"]
        D3["Valida argumentos<br/><code>serde_json::from_str::&lt;Value&gt;()</code>"]
    end

    subgraph Implementation["‚öôÔ∏è IMPLEMENTA√á√ÉO RUST"]
        E1["Defini√ß√£o da Tool<br/>exec_command/mod.rs<br/><code>pub struct ExecCommandTool;</code>"]
        E2["Trait implementation<br/><code>impl Tool for ExecCommandTool {<br/>  async fn execute(&self,<br/>    params: Value) -&gt; Result&lt;Value&gt;<br/>}</code>"]
        E3["Registro da ferramenta<br/>responses_api.rs<br/><code>create_exec_command_tool_for_responses_api()</code>"]
        E4["Parsing de par√¢metros<br/><code>ExecCommandParams::deserialize(params)</code>"]
    end

    subgraph Sandbox["üõ°Ô∏è EXECU√á√ÉO E SANDBOX"]
        F1["Verifica pol√≠tica de sandbox<br/>protocol.rs<br/><code>SandboxPolicy::WorkspaceWrite {<br/>  network_access: bool<br/>}</code>"]
        F2["Cria sandbox macOS<br/>seatbelt.rs<br/><code>spawn_command_under_seatbelt(<br/>  command: Vec&lt;String&gt;,<br/>  policy: &SandboxPolicy<br/>)</code>"]
        F3["Executa processo filho<br/>spawn.rs<br/><code>spawn_child_async(<br/>  binary: PathBuf,<br/>  args: Vec&lt;String&gt;<br/>)</code>"]
    end

    subgraph Session["üì° SESS√ÉO E OUTPUT"]
        G1["Cria sess√£o PTY<br/>exec_command_session.rs<br/><code>ExecCommandSession {<br/>  writer_tx: mpsc::Sender&lt;Vec&lt;u8&gt;&gt;,<br/>  output_tx: broadcast::Sender&lt;Vec&lt;u8&gt;&gt;<br/>}</code>"]
        G2["Gerencia ciclo de vida<br/>session_manager.rs<br/><code>SessionManager::handle_exec_command_request()</code>"]
        G3["Coleta e trunca sa√≠da<br/><code>truncate_middle(output, max_bytes)</code>"]
    end

    subgraph Output["üíæ SALVAMENTO/RETORNO"]
        H1["Salva resultado conforme tool<br/>apply_patch.rs<br/><code>apply_patch_to_file(patch_content)</code>"]
        H2["Retorna ResponseInputItem<br/><code>ResponseInputItem::FunctionCallOutput {<br/>  call_id,<br/>  output: FunctionCallOutputPayload<br/>}</code>"]
    end

    %% A√ß√µes e Objetos Paralelos
    subgraph Eventos["‚ö° EVENTOS E NOTIFICA√á√ïES ASS√çNCRONAS"]
        J1["Eventos de in√≠cio de tool call<br/>mcp_tool_call.rs<br/><code>McpToolCallBeginEvent {<br/>  call_id, invocation<br/>}</code>"]
        J2["Eventos de fim de tool call<br/><code>McpToolCallEndEvent {<br/>  call_id, result, duration<br/>}</code>"]
        J3["Notifica√ß√µes de progresso<br/>user_notification.rs<br/><code>UserNotification::send()</code>"]
    end

    subgraph Logs["üìä LOGGING E AUDITORIA"]
        K1["Log de comandos executados<br/>message_history.rs<br/><code>MessageHistory::add_command()</code>"]
        K2["Auditoria de sandbox<br/>safety.rs<br/><code>log_sandbox_violation()</code>"]
        K3["M√©tricas de performance<br/><code>wall_time, token_count</code>"]
    end

    subgraph Config["‚öôÔ∏è CONFIGURA√á√ÉO DIN√ÇMICA"]
        L1["Carregamento de perfis<br/>config_profile.rs<br/><code>ConfigProfile::load()</code>"]
        L2["Aplica√ß√£o de overrides<br/>config.rs<br/><code>apply_config_overrides()</code>"]
        L3["Valida√ß√£o de seguran√ßa<br/>is_safe_command.rs<br/><code>is_command_safe()</code>"]
    end

    subgraph PTYTasks["üîß TAREFAS PTY ASS√çNCRONAS"]
        M1["Reader Task<br/><code>tokio::task::spawn_blocking(<br/>  reader.read(&mut buf)<br/>)</code>"]
        M2["Writer Task<br/><code>tokio::spawn(writer_loop)</code>"]
        M3["Wait Task<br/><code>child.wait() em thread</code>"]
    end

    subgraph Cleanup["üßπ LIMPEZA AUTOM√ÅTICA"]
        N1["Drop de ExecCommandSession<br/><code>impl Drop {<br/>  killer.kill();<br/>  handle.abort()<br/>}</code>"]
        N2["Timeout de sess√µes<br/>session_manager.rs<br/><code>cleanup_expired_sessions()</code>"]
        N3["Garbage collection de handles<br/><code>JoinHandle::abort()</code>"]
    end

    %% Fluxo principal
    A1 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> C1
    C1 --> D1
    D1 --> D2
    D2 --> D3
    D3 --> E1
    E1 --> E2
    E2 --> E3
    E3 --> E4
    E4 --> F1
    F1 --> F2
    F2 --> F3
    F3 --> G1
    G1 --> G2
    G2 --> G3
    G3 --> H1
    H1 --> H2

    %% A√ß√µes paralelas e ass√≠ncronas
    D1 -.-> J1
    H1 -.-> J2
    B2 -.-> J3
    
    F3 -.-> K1
    F1 -.-> K2
    G3 -.-> K3
    
    B1 -.-> L1
    E4 -.-> L2
    F1 -.-> L3
    
    G1 -.-> M1
    G1 -.-> M2
    G1 -.-> M3
    
    H2 -.-> N1
    G2 -.-> N2
    M1 -.-> N3
    M2 -.-> N3
    M3 -.-> N3

    %% Eventos de inicializa√ß√£o e configura√ß√£o
    subgraph Init["üöÄ INICIALIZA√á√ÉO"]
        I1["Carregamento do MCP<br/>mcp_connection_manager.rs<br/><code>McpConnectionManager::new()</code>"]
        I2["Inicializa√ß√£o do TUI<br/>tui/src/app.rs<br/><code>App::new()</code>"]
        I3["Setup do terminal<br/>terminal.rs<br/><code>user_agent()</code>"]
    end

    A1 -.-> I1
    A1 -.-> I2
    A1 -.-> I3